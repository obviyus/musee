---
import type { ProcessedImage } from "../utils/processedImages";

interface Props {
	images: ProcessedImage[];
}

const { images } = Astro.props;

// Pre-calculate column distributions for each breakpoint
function distributeIntoColumns(items: ProcessedImage[], columnCount: number) {
	const columns: ProcessedImage[][] = Array.from(
		{ length: columnCount },
		() => [],
	);
	// Distribute horizontally: 1,2,3,4 then 5,6,7,8
	for (let i = 0; i < items.length; i++) {
		columns[i % columnCount].push(items[i]);
	}
	return columns;
}

const breakpoints = [
	{ key: "mobile", columns: 1 },
	{ key: "sm", columns: 2 },
	{ key: "md", columns: 3 },
	{ key: "lg", columns: 4 },
	{ key: "xl", columns: 5 },
] as const;

const columnsByBreakpoint = Object.fromEntries(
	breakpoints.map(({ key, columns }) => [
		key,
		distributeIntoColumns(images, columns),
	]),
) as Record<string, ProcessedImage[][]>;
---

{
	breakpoints.map(({ key, columns }) => (
		<div class={`masonry-grid masonry-${key}`}>
			{columnsByBreakpoint[key].map((column, colIndex) => (
				<div class="masonry-column">
					{column.map((image, index) => {
						const globalIndex = colIndex + index * columns;
						return (
							<div
								class="masonry-item opacity-0"
								style={`animation-delay: ${(globalIndex % 5) * 0.05}s`}
							>
								<a
									href={`/image/${image.slug}`}
									aria-label={`View image ${image.slug}`}
								>
									<img
										src={image.thumbnail.src as string}
										width={
											image.thumbnail.attributes
												.width as number
										}
										height={
											image.thumbnail.attributes
												.height as number
										}
										alt={`Thumbnail for ${image.slug}`}
										loading="lazy"
										decoding="async"
										class="transition-transform duration-300 ease-in-out hover:-translate-y-1 hover:scale-110 will-change-transform"
									/>
								</a>
							</div>
						);
					})}
				</div>
			))}
		</div>
	))
}

<style>
	.masonry-grid {
		display: none;
		overflow: hidden;
	}

	.masonry-column {
		flex: 1;
		display: flex;
		flex-direction: column;
		margin-right: -1px;
	}

	/* Mobile (default) */
	.masonry-mobile {
		display: flex;
	}

	@media (min-width: 500px) {
		.masonry-mobile {
			display: none;
		}
		.masonry-sm {
			display: flex;
		}
	}

	@media (min-width: 1000px) {
		.masonry-sm {
			display: none;
		}
		.masonry-md {
			display: flex;
		}
	}

	@media (min-width: 1500px) {
		.masonry-md {
			display: none;
		}
		.masonry-lg {
			display: flex;
		}
	}

	@media (min-width: 2000px) {
		.masonry-lg {
			display: none;
		}
		.masonry-xl {
			display: flex;
		}
	}

	.masonry-item {
		width: 100%;
		line-height: 0;
		margin-top: -1px;
		animation: fadeIn 0.5s ease-out forwards;
	}

	.masonry-item:first-child {
		margin-top: 0;
	}

	.masonry-item a {
		display: block;
	}

	.masonry-item img {
		display: block;
		width: 100%;
		height: auto;
	}

	@keyframes fadeIn {
		from {
			opacity: 0;
			transform: translateY(10px);
		}
		to {
			opacity: 1;
			transform: translateY(0);
		}
	}
</style>
