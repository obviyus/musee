---
import { getImage } from "astro:assets";
import BaseImage from "../../components/BaseImage.astro";
import BaseIndex from "../../layouts/BaseIndex.astro";
import images from "../../utils/allImages";
import { getImageDate } from "../../utils/imageDate";
import { dashify } from "../../utils/slug";

export async function getStaticPaths() {
	const imageEntries = Object.entries(images);

	// Process all images in parallel
	const staticPaths = await Promise.all(
		imageEntries.map(async ([key, value]) => {
			// Format slug with dashes for readability
			const dashedSlug = dashify(key);

			// Get date and images in parallel
			const [date, original, thumbnail] = await Promise.all([
				getImageDate(value),
				getImage({
					src: value,
					format: "webp",
				}),
				getImage({
					src: value,
					width: 640,
					quality: 80,
					format: "webp",
				}),
			]);

			return {
				params: {
					slug: dashedSlug,
				},
				props: {
					date,
					slug: dashedSlug,
					src: original.src,
					width: original.attributes.width,
					height: original.attributes.height,
					thumbnailSrc: thumbnail.src,
					alt: `Image ${dashedSlug}`,
				},
			};
		}),
	);

	return staticPaths;
}

const { slug } = Astro.params;
const props = Astro.props;
---

<BaseIndex
	title={`Image ${slug} - Galerie d'Ayaan`}
	description="Ayaan Zaidi's personal image feed. Mild obsession with aircrafts and shiny things. Mostly shot on a mobile camera."
	previewImage={props.thumbnailSrc}
>
	<BaseImage {...props} />
</BaseIndex>
