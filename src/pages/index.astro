---
import { getImage } from "astro:assets";
import MasonryGrid, { type SortedImage } from "../components/masonry-css.astro";
import BaseIndex from "../layouts/BaseIndex.astro";
import images from "../assets/images/imageList";
import { getImageDate } from "../utils/imageDate";

const sortedImages: SortedImage[] = [];

function compareByDate(a: SortedImage, b: SortedImage): number {
	return b.date.getTime() - a.date.getTime();
}

const imageEntries = Object.entries(images);

const processedImages = await Promise.all(
	imageEntries.map(async ([key, value]) => {
		const [date, original, thumbnail] = await Promise.all([
			getImageDate(value),
			getImage({
				src: value,
				format: "webp",
			}),
			getImage({
				src: value,
				width: 640,
				quality: 80,
				format: "webp",
			}),
		]);

		// Format slug with dashes for readability
		const dashedSlug = `${key.slice(0, 3)}-${key.slice(3, -3)}-${key.slice(-3)}`;

		return {
			original,
			thumbnail,
			date,
			slug: `image/${dashedSlug}`,
		};
	}),
);

// Sort all at once using Bun's optimized sort
processedImages.sort(compareByDate);
sortedImages.push(...processedImages);
---

<BaseIndex
	title="Galerie d'Ayaan"
	description="Ayaan Zaidi's personal image feed. Mild obsession with aircrafts and shiny things. Mostly shot on a mobile camera."
	permalink="https://gallery.obviy.us/"
>
	<MasonryGrid images={sortedImages} />
</BaseIndex>
